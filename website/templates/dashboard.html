<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveAhead F1 - Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-zinc-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-zinc-800 border-b border-zinc-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="DriveAhead F1 Logo" class="h-8 w-8 mr-3">
                    <h1 class="text-xl font-bold">DriveAhead F1</h1>
                    <span class="ml-2 text-xs bg-blue-600 px-2 py-1 rounded-full">Live</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="px-3 py-2 text-white bg-blue-600 rounded-md">Dashboard</a>
                    <a href="/telemetry" class="px-3 py-2 text-zinc-300 hover:text-white">Telemetry</a>
                    <a href="/standings" class="px-3 py-2 text-zinc-300 hover:text-white">Standings</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Header with Real-time Timestamp -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold text-white">F1 Analytics Dashboard</h2>
                    <p class="text-zinc-400 mt-2">Live Formula 1 data and advanced predictions</p>
                </div>
                <div class="text-right">
                    <div class="text-lg font-semibold text-green-400" id="liveTimestamp">--:--:--</div>
                    <div class="text-sm text-zinc-400">Live Update</div>
                    <div class="text-xs text-zinc-500" id="raceStatus">Race Status: Standby</div>
                </div>
            </div>
        </div>

        <!-- Next Race Section with Countdown -->
        <div class="bg-zinc-800 rounded-lg p-6 mb-6 border border-zinc-700">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-flag-checkered mr-2 text-red-500"></i>
                Next Race
            </h3>
            <div id="nextRaceInfo" class="space-y-4">
                <div class="animate-pulse">
                    <div class="h-4 bg-zinc-700 rounded w-1/3 mb-2"></div>
                    <div class="h-4 bg-zinc-700 rounded w-1/4 mb-2"></div>
                    <div class="h-4 bg-zinc-700 rounded w-1/2"></div>
                </div>
            </div>
            
            <!-- Race Countdown Timer -->
            <div class="mt-6 bg-zinc-900 rounded-lg p-4 border border-zinc-600">
                <div class="text-center">
                    <div class="text-sm text-zinc-400 mb-2">TIME TO NEXT RACE</div>
                    <div id="raceCountdown" class="font-mono text-2xl font-bold text-green-400">
                        00DAYS : 00HOURS : 00MINUTES
                    </div>
                    <div class="text-xs text-zinc-500 mt-2" id="countdownSubtext">Loading countdown...</div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Driver Standings -->
            <div class="bg-zinc-800 rounded-lg p-6 border border-zinc-700">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-trophy mr-2 text-yellow-500"></i>
                    Driver Standings
                </h3>
                <div id="driverStandings" class="space-y-2">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse space-y-2">
                        <div class="flex justify-between items-center p-2 bg-zinc-700 rounded">
                            <div class="h-4 bg-zinc-600 rounded w-1/3"></div>
                            <div class="h-4 bg-zinc-600 rounded w-16"></div>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-zinc-700 rounded">
                            <div class="h-4 bg-zinc-600 rounded w-1/3"></div>
                            <div class="h-4 bg-zinc-600 rounded w-16"></div>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-zinc-700 rounded">
                            <div class="h-4 bg-zinc-600 rounded w-1/3"></div>
                            <div class="h-4 bg-zinc-600 rounded w-16"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Constructor Standings -->
            <div class="bg-zinc-800 rounded-lg p-6 border border-zinc-700">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-car mr-2 text-blue-500"></i>
                    Constructor Standings
                </h3>
                <div id="constructorStandings" class="space-y-2">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse space-y-2">
                        <div class="flex justify-between items-center p-2 bg-zinc-700 rounded">
                            <div class="h-4 bg-zinc-600 rounded w-1/2"></div>
                            <div class="h-4 bg-zinc-600 rounded w-16"></div>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-zinc-700 rounded">
                            <div class="h-4 bg-zinc-600 rounded w-1/2"></div>
                            <div class="h-4 bg-zinc-600 rounded w-16"></div>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-zinc-700 rounded">
                            <div class="h-4 bg-zinc-600 rounded w-1/2"></div>
                            <div class="h-4 bg-zinc-600 rounded w-16"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Race Predictions -->
        <div class="bg-zinc-800 rounded-lg p-6 border border-zinc-700">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-green-500"></i>
                Race Predictions
                <span class="ml-2 text-xs bg-green-600 px-2 py-1 rounded-full">Live Analysis</span>
            </h3>
            <div id="racePredictions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Loading skeleton -->
                <div class="animate-pulse">
                    <div class="h-6 bg-zinc-700 rounded w-1/3 mb-2"></div>
                    <div class="h-4 bg-zinc-700 rounded w-full mb-1"></div>
                    <div class="h-4 bg-zinc-700 rounded w-3/4"></div>
                </div>
                <div class="animate-pulse">
                    <div class="h-6 bg-zinc-700 rounded w-1/3 mb-2"></div>
                    <div class="h-4 bg-zinc-700 rounded w-full mb-1"></div>
                    <div class="h-4 bg-zinc-700 rounded w-3/4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-zinc-800 border-t border-zinc-700 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-zinc-400">© 2025 DriveAhead F1 - Advanced Analytics</p>
                    <p class="text-xs text-zinc-500">Real-time F1 Data • Live Predictions</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-zinc-400">Status:</span>
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse-slow"></div>
                    <span class="text-xs text-green-400">Live</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Load dashboard data
        class Dashboard {
            constructor() {
                this.loadNextRace();
                this.loadStandings();
                this.loadPredictions();
                
                // Refresh data every 30 seconds
                setInterval(() => {
                    this.refreshData();
                }, 30000);
            }

            async loadNextRace() {
                try {
                    const response = await fetch('/api/next-race');
                    const data = await response.json();
                    
                    if (data.race) {
                        const race = data.race;
                        document.getElementById('nextRaceInfo').innerHTML = `
                            <div class="space-y-2">
                                <h4 class="text-lg font-semibold text-white">${race.name}</h4>
                                <p class="text-zinc-300"><i class="fas fa-map-marker-alt mr-2"></i>${race.location}</p>
                                <p class="text-zinc-300"><i class="fas fa-calendar mr-2"></i>${new Date(race.date).toLocaleDateString('en-US', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}</p>
                                <p class="text-zinc-300"><i class="fas fa-clock mr-2"></i>${race.time} Local Time</p>
                            </div>
                        `;
                        
                        // Set up countdown timer
                        this.setupRaceCountdown(race.date, race.time);
                    }
                } catch (error) {
                    console.error('Error loading next race:', error);
                }
            }

            setupRaceCountdown(raceDate, raceTime) {
                // Create target date - combining race date and time
                const targetDate = new Date(`${raceDate}T${raceTime || '14:00:00'}`);
                
                // Function to update countdown
                const updateCountdown = () => {
                    const now = new Date();
                    const timeDiff = targetDate.getTime() - now.getTime();
                    
                    if (timeDiff <= 0) {
                        // Race has started or passed
                        document.getElementById('raceCountdown').textContent = '00DAYS : 00HOURS : 00MINUTES';
                        document.getElementById('countdownSubtext').textContent = 'Race has started!';
                        return;
                    }
                    
                    // Calculate time components
                    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    // Format with leading zeros - exact format from render site
                    const formattedDays = String(days).padStart(2, '0');
                    const formattedHours = String(hours).padStart(2, '0');
                    const formattedMinutes = String(minutes).padStart(2, '0');
                    
                    // Update display with exact format: 00DAYS : 00HOURS : 00MINUTES
                    document.getElementById('raceCountdown').textContent = 
                        `${formattedDays}DAYS : ${formattedHours}HOURS : ${formattedMinutes}MINUTES`;
                    
                    // Update subtext
                    if (days > 0) {
                        document.getElementById('countdownSubtext').textContent = 
                            `${days} day${days !== 1 ? 's' : ''} until lights out`;
                    } else if (hours > 0) {
                        document.getElementById('countdownSubtext').textContent = 
                            `${hours} hour${hours !== 1 ? 's' : ''} until race start`;
                    } else {
                        document.getElementById('countdownSubtext').textContent = 
                            `${minutes} minute${minutes !== 1 ? 's' : ''} until race start`;
                    }
                };
                
                // Update immediately
                updateCountdown();
                
                // Update every minute
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                }
                this.countdownInterval = setInterval(updateCountdown, 60000);
            }

            async loadStandings() {
                try {
                    const response = await fetch('/api/standings');
                    const data = await response.json();
                    
                    // Data comes directly without wrapper
                    if (data.drivers && data.constructors) {
                        this.renderDriverStandings(data.drivers);
                        this.renderConstructorStandings(data.constructors);
                    }
                } catch (error) {
                    console.error('Error loading standings:', error);
                }
            }

            renderDriverStandings(drivers) {
                const container = document.getElementById('driverStandings');
                container.innerHTML = drivers.slice(0, 10).map(driver => `
                    <div class="flex justify-between items-center p-2 bg-zinc-700 rounded hover:bg-zinc-600 transition-colors">
                        <div class="flex items-center">
                            <span class="w-6 text-center font-mono text-sm">${driver.position}</span>
                            <span class="ml-3 font-medium">${driver.driver}</span>
                            <span class="ml-2 text-xs text-zinc-400">${driver.team}</span>
                        </div>
                        <span class="font-mono text-yellow-400">${driver.points}</span>
                    </div>
                `).join('');
            }

            renderConstructorStandings(constructors) {
                const container = document.getElementById('constructorStandings');
                container.innerHTML = constructors.slice(0, 10).map(constructor => `
                    <div class="flex justify-between items-center p-2 bg-zinc-700 rounded hover:bg-zinc-600 transition-colors">
                        <div class="flex items-center">
                            <span class="w-6 text-center font-mono text-sm">${constructor.position}</span>
                            <span class="ml-3 font-medium">${constructor.team}</span>
                        </div>
                        <span class="font-mono text-yellow-400">${constructor.points}</span>
                    </div>
                `).join('');
            }

            async loadPredictions() {
                try {
                    const response = await fetch('/api/predictions');
                    const data = await response.json();
                    
                    // Data comes directly without wrapper
                    if (data.predictions) {
                        this.renderPredictions(data.predictions);
                    }
                } catch (error) {
                    console.error('Error loading predictions:', error);
                }
            }

            renderPredictions(predictions) {
                const container = document.getElementById('racePredictions');
                const winner = predictions[0]; // First prediction is the winner
                const podium = predictions.slice(0, 3); // Top 3 for podium
                
                container.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-green-400 mb-2">Race Winner</h4>
                        <div class="bg-zinc-700 p-3 rounded">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">${winner.driver}</span>
                                <span class="text-green-400">${winner.probability}%</span>
                            </div>
                            <p class="text-xs text-zinc-400 mt-1">${winner.team}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-blue-400 mb-2">Podium Predictions</h4>
                        <div class="space-y-2">
                            ${podium.map((driver, index) => `
                                <div class="bg-zinc-700 p-2 rounded flex justify-between items-center">
                                    <div class="flex items-center">
                                        <span class="w-6 text-center text-xs">${index + 1}</span>
                                        <span class="ml-2 text-sm">${driver.driver}</span>
                                    </div>
                                    <span class="text-xs text-blue-400">${driver.probability}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            async refreshData() {
                console.log('Refreshing dashboard data...');
                await this.loadStandings();
                await this.loadPredictions();
                
                // Update timestamp and race status
                this.updateTimestamp();
                this.updateRaceStatus();
            }

            updateTimestamp() {
                const now = new Date();
                const timestamp = now.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('liveTimestamp').textContent = timestamp;
            }

            updateRaceStatus() {
                // Check if it's race weekend (simulate)
                const now = new Date();
                const dayOfWeek = now.getDay();
                const hour = now.getHours();
                
                let status = 'Standby';
                let statusClass = 'text-zinc-500';
                
                // Simulate race weekend activity (Friday-Sunday)
                if (dayOfWeek >= 5 && dayOfWeek <= 0) {
                    if (dayOfWeek === 5) { // Friday - Practice
                        status = 'Practice Sessions';
                        statusClass = 'text-blue-400';
                    } else if (dayOfWeek === 6) { // Saturday - Qualifying
                        status = 'Qualifying Day';
                        statusClass = 'text-yellow-400';
                    } else if (dayOfWeek === 0) { // Sunday - Race
                        if (hour >= 13 && hour <= 16) { // Race time
                            status = 'RACE ACTIVE';
                            statusClass = 'text-red-400 animate-pulse';
                        } else {
                            status = 'Race Day';
                            statusClass = 'text-green-400';
                        }
                    }
                }
                
                const statusElement = document.getElementById('raceStatus');
                statusElement.textContent = `Race Status: ${status}`;
                statusElement.className = `text-xs ${statusClass}`;
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const dashboard = new Dashboard();
            
            // Update timestamp every second
            setInterval(() => {
                dashboard.updateTimestamp();
            }, 1000);
            
            // Update race status every 30 seconds
            setInterval(() => {
                dashboard.updateRaceStatus();
            }, 30000);
            
            // Initialize timestamp immediately
            dashboard.updateTimestamp();
            dashboard.updateRaceStatus();
        });
    </script>
</body>
</html>